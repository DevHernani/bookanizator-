<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organizar Estante - BookAnizator</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .shelf-organizer {
      max-width: 900px;
      margin: 2rem auto;
      padding: 2rem;
    }

    .upload-area {
      border: 3px dashed var(--border-color);
      border-radius: var(--radius-lg);
      padding: 3rem;
      text-align: center;
      background: var(--surface-color);
      cursor: pointer;
      transition: var(--transition);
      margin-bottom: 2rem;
    }

    .upload-area:hover {
      border-color: var(--primary-color);
      background: var(--background-color);
    }

    .upload-area.dragover {
      border-color: var(--primary-color);
      background: #eff6ff;
    }

    .camera-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .preview-container {
      margin: 2rem 0;
      text-align: center;
    }

    .preview-image {
      max-width: 100%;
      max-height: 400px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
    }

    .analysis-container {
      background: var(--surface-color);
      border-radius: var(--radius-lg);
      padding: 2rem;
      margin-top: 2rem;
    }

    .suggestion-card {
      background: var(--background-color);
      border-left: 4px solid var(--primary-color);
      padding: 1.5rem;
      margin: 1rem 0;
      border-radius: var(--radius-md);
    }

    .suggestion-card h4 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .books-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .book-item {
      background: white;
      padding: 1rem;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-sm);
      font-size: 0.875rem;
    }

    .organization-type {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-bottom: 1rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-color);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .api-warning {
      background: #fef3c7;
      border-left: 4px solid var(--warning-color);
      padding: 1rem;
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="shelf-organizer">
    <div class="section-header">
      <h1>üìö Organizar Estante com IA</h1>
      <p>Tire uma foto da sua estante e receba sugest√µes de organiza√ß√£o!</p>
      <a href="index.html" style="color: var(--primary-color); text-decoration: none;">‚Üê Voltar</a>
    </div>

    <div id="api-warning" class="api-warning" style="display: none;">
      <strong>‚ö†Ô∏è API Key n√£o configurada</strong>
      <p>Configure sua API key do Claude nas <a href="index.html#settings">Configura√ß√µes</a> para usar esta funcionalidade.</p>
    </div>

    <div class="card">
      <h3 class="card-title">1. Envie uma Foto da Estante</h3>

      <div id="upload-area" class="upload-area">
        <div class="camera-icon">üì∑</div>
        <h3>Clique ou arraste uma foto aqui</h3>
        <p style="color: var(--text-secondary); margin-top: 0.5rem;">
          Tire uma foto da sua estante de livros
        </p>
        <input type="file" id="photo-input" accept="image/*" capture="environment" style="display: none;">
      </div>

      <div id="preview-container" class="preview-container" style="display: none;">
        <img id="preview-image" class="preview-image" alt="Preview">
        <div style="margin-top: 1rem;">
          <button id="analyze-btn" class="btn btn-primary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Analisar com IA
          </button>
          <button id="change-photo-btn" class="btn btn-secondary">Trocar Foto</button>
        </div>
      </div>
    </div>

    <div id="analysis-container" class="analysis-container" style="display: none;">
      <h3 class="card-title">2. Sugest√µes de Organiza√ß√£o</h3>
      <div id="suggestions-content"></div>
    </div>

    <div class="card" style="margin-top: 2rem;">
      <h3 class="card-title">üí° Dicas</h3>
      <ul style="color: var(--text-secondary); line-height: 1.8;">
        <li>Tire a foto com boa ilumina√ß√£o</li>
        <li>Mostre uma se√ß√£o da estante por vez para melhor an√°lise</li>
        <li>A IA vai comparar com os livros da sua biblioteca cadastrada</li>
        <li>Voc√™ receber√° v√°rias sugest√µes de organiza√ß√£o (por categoria, autor, cor, etc.)</li>
      </ul>
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script>
    let selectedImage = null;
    let selectedImageData = null;

    // Check API key
    window.addEventListener('DOMContentLoaded', () => {
      const apiKey = Storage.getApiKey();
      if (!apiKey) {
        document.getElementById('api-warning').style.display = 'block';
      }
    });

    // Upload area events
    const uploadArea = document.getElementById('upload-area');
    const photoInput = document.getElementById('photo-input');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    const analyzeBtn = document.getElementById('analyze-btn');
    const changePhotoBtn = document.getElementById('change-photo-btn');
    const analysisContainer = document.getElementById('analysis-container');
    const suggestionsContent = document.getElementById('suggestions-content');

    uploadArea.addEventListener('click', () => {
      photoInput.click();
    });

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');

      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleImageFile(file);
      }
    });

    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleImageFile(file);
      }
    });

    function handleImageFile(file) {
      selectedImage = file;

      const reader = new FileReader();
      reader.onload = (e) => {
        selectedImageData = e.target.result;
        previewImage.src = selectedImageData;
        uploadArea.style.display = 'none';
        previewContainer.style.display = 'block';
        analysisContainer.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }

    changePhotoBtn.addEventListener('click', () => {
      uploadArea.style.display = 'block';
      previewContainer.style.display = 'none';
      analysisContainer.style.display = 'none';
      photoInput.value = '';
      selectedImage = null;
      selectedImageData = null;
    });

    analyzeBtn.addEventListener('click', async () => {
      const apiKey = Storage.getApiKey();

      if (!apiKey) {
        alert('Por favor, configure sua API key do Claude nas Configura√ß√µes.');
        window.location.href = 'index.html#settings';
        return;
      }

      if (!selectedImageData) {
        alert('Por favor, selecione uma imagem primeiro.');
        return;
      }

      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<div class="loading-spinner"></div> Analisando...';

      try {
        const books = Storage.getBooks();
        const suggestions = await analyzeShelfWithAI(selectedImageData, books, apiKey);

        displaySuggestions(suggestions);
        analysisContainer.style.display = 'block';
        analysisContainer.scrollIntoView({ behavior: 'smooth' });

      } catch (error) {
        console.error('Error analyzing shelf:', error);
        alert('Erro ao analisar a estante: ' + error.message);
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Analisar com IA
        `;
      }
    });

    async function analyzeShelfWithAI(imageData, books, apiKey) {
      // Convert base64 to proper format for Claude API
      const base64Image = imageData.split(',')[1];
      const mediaType = imageData.split(';')[0].split(':')[1];

      const booksList = books.map(b => `- "${b.title}" por ${b.authors.join(', ')} (${b.category}, ${b.language})`).join('\n');

      const prompt = `Voc√™ √© um especialista em organiza√ß√£o de bibliotecas pessoais.

Analise esta foto de uma estante de livros e forne√ßa sugest√µes detalhadas de como organizar.

LIVROS NA BIBLIOTECA DO USU√ÅRIO:
${booksList}

Forne√ßa sugest√µes de organiza√ß√£o considerando:
1. Organiza√ß√£o por CATEGORIA (agrupe livros semelhantes)
2. Organiza√ß√£o por AUTOR (alfab√©tico)
3. Organiza√ß√£o por COR (visual atraente)
4. Organiza√ß√£o por TAMANHO (est√©tica)
5. Organiza√ß√£o TEM√ÅTICA (crie "ilhas" de assuntos)

Para cada sugest√£o, explique:
- Como organizar
- Vantagens dessa organiza√ß√£o
- Quais livros da biblioteca ficariam juntos

Responda em JSON com este formato:
{
  "books_visible": ["livro1", "livro2"],
  "suggestions": [
    {
      "type": "Por Categoria",
      "description": "Descri√ß√£o da organiza√ß√£o",
      "benefits": ["benef√≠cio1", "benef√≠cio2"],
      "example_groups": [
        {"group": "Filosofia", "books": ["livro1", "livro2"]},
        {"group": "Literatura", "books": ["livro3"]}
      ]
    }
  ]
}`;

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 2000,
          messages: [
            {
              role: 'user',
              content: [
                {
                  type: 'image',
                  source: {
                    type: 'base64',
                    media_type: mediaType,
                    data: base64Image
                  }
                },
                {
                  type: 'text',
                  text: prompt
                }
              ]
            }
          ]
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || 'Erro na API do Claude');
      }

      const data = await response.json();
      const content = data.content[0].text;

      const jsonMatch = content.match(/\{[\s\S]*\}/);
      if (!jsonMatch) {
        throw new Error('Resposta inv√°lida da IA');
      }

      return JSON.parse(jsonMatch[0]);
    }

    function displaySuggestions(data) {
      let html = '';

      if (data.books_visible && data.books_visible.length > 0) {
        html += `
          <div style="background: #e0f2fe; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <strong>üìñ Livros vis√≠veis na foto:</strong>
            <p style="margin-top: 0.5rem;">${data.books_visible.join(', ')}</p>
          </div>
        `;
      }

      data.suggestions.forEach((suggestion, index) => {
        html += `
          <div class="suggestion-card">
            <span class="organization-type">${suggestion.type}</span>
            <h4>${suggestion.description}</h4>

            ${suggestion.benefits ? `
              <div style="margin: 1rem 0;">
                <strong>‚ú® Vantagens:</strong>
                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                  ${suggestion.benefits.map(b => `<li>${b}</li>`).join('')}
                </ul>
              </div>
            ` : ''}

            ${suggestion.example_groups ? `
              <div style="margin-top: 1rem;">
                <strong>üìö Exemplo de organiza√ß√£o:</strong>
                ${suggestion.example_groups.map(group => `
                  <div style="margin-top: 1rem; padding: 0.75rem; background: white; border-radius: 6px;">
                    <strong style="color: var(--primary-color);">${group.group}:</strong>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                      ${group.books.join(' ‚Ä¢ ')}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      });

      suggestionsContent.innerHTML = html;
    }
  </script>
</body>
</html>
